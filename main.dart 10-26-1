// main.dart â€” ìš¸ì‚°ìº˜ë¦°ë” ì™„ì„±í˜• (v2025.10)
// ì „ì²´ í•œ íŒŒì¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥ / Flutter 3.35.x verified

import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:intl/intl.dart';
import 'package:intl/date_symbol_data_local.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:html/parser.dart' as html_parser;
import 'package:html/dom.dart' as dom;

// ================== ê¸°ë³¸ ì„¤ì • ==================
const String NEWS_API_KEY = '2b208ebd795b4f0fb9e380844f894932'; // â† ì—¬ê¸°ì— ë³¸ì¸ í‚¤ ì…ë ¥
const String kAdminPassword = '20201971'; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
// ==============================================

// í…Œë§ˆ ì „ì—­ ì»¨íŠ¸ë¡¤ëŸ¬
final ValueNotifier<ThemeMode> appTheme = ValueNotifier(ThemeMode.system);

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await initializeDateFormatting('ko_KR', null);

  final prefs = await SharedPreferences.getInstance();
  final themeStr = prefs.getString('theme_mode') ?? 'system';
  appTheme.value = switch (themeStr) {
    'light' => ThemeMode.light,
    'dark' => ThemeMode.dark,
    _ => ThemeMode.system,
  };

  runApp(const UlsanCalendarApp());
}

class UlsanCalendarApp extends StatelessWidget {
  const UlsanCalendarApp({super.key});
  @override
  Widget build(BuildContext context) {
    return ValueListenableBuilder<ThemeMode>(
      valueListenable: appTheme,
      builder: (_, mode, __) {
        return MaterialApp(
          title: 'ìš¸ì‚°ìº˜ë¦°ë”',
          debugShowCheckedModeBanner: false,
          themeMode: mode,
          theme: ThemeData(useMaterial3: true, colorSchemeSeed: Colors.blue),
          darkTheme: ThemeData(
            useMaterial3: true,
            colorSchemeSeed: Colors.blue,
            brightness: Brightness.dark,
          ),
          home: const MainPage(),
        );
      },
    );
  }
}

// ================== ë°ì´í„° ëª¨ë¸ ==================
enum EventCategory { festival, exhibition, sport }

extension EventCategoryX on EventCategory {
  String get label => switch (this) {
    EventCategory.festival => 'ì¶•ì œ',
    EventCategory.exhibition => 'ê³µì—°Â·ì „ì‹œ',
    EventCategory.sport => 'ìŠ¤í¬ì¸ ',
  };

  Color get pastel => switch (this) {
    EventCategory.festival => Colors.redAccent,
    EventCategory.exhibition => Colors.greenAccent,
    EventCategory.sport => Colors.blueAccent,
  }.shade100;

  Color get dot => switch (this) {
    EventCategory.festival => Colors.redAccent,
    EventCategory.exhibition => Colors.greenAccent,
    EventCategory.sport => Colors.blueAccent,
  }.shade200;
}

class EventItem {
  final String title;
  final DateTime start;
  final DateTime end;
  final EventCategory category;
  final String? url;

  EventItem({
    required this.title,
    required this.start,
    required this.end,
    required this.category,
    this.url,
  });

  Map<String, dynamic> toJson() => {
    'title': title,
    'start': start.toIso8601String(),
    'end': end.toIso8601String(),
    'category': category.name,
    'url': url,
  };

  factory EventItem.fromJson(Map<String, dynamic> j) => EventItem(
    title: j['title'],
    start: DateTime.parse(j['start']),
    end: DateTime.parse(j['end']),
    category:
    EventCategory.values.firstWhere((e) => e.name == j['category']),
    url: j['url'],
  );
}

class NewsHeadline {
  final String title;
  final String? url;
  final EventCategory category;

  NewsHeadline({
    required this.title,
    this.url,
    required this.category,
  });
}

class PostItem {
  final String id;
  final String content;
  final DateTime createdAt;
  final int likes;

  PostItem({
    required this.id,
    required this.content,
    required this.createdAt,
    required this.likes,
  });

  PostItem copyWith({int? likes}) => PostItem(
    id: id,
    content: content,
    createdAt: createdAt,
    likes: likes ?? this.likes,
  );

  Map<String, dynamic> toJson() => {
    'id': id,
    'content': content,
    'createdAt': createdAt.toIso8601String(),
    'likes': likes,
  };

  factory PostItem.fromJson(Map<String, dynamic> j) => PostItem(
    id: j['id'],
    content: j['content'],
    createdAt: DateTime.parse(j['createdAt']),
    likes: j['likes'] ?? 0,
  );
}

// ================== ë©”ì¸ í˜ì´ì§€ ==================
class MainPage extends StatefulWidget {
  const MainPage({super.key});
  @override
  State<MainPage> createState() => _MainPageState();
}

class _MainPageState extends State<MainPage> {
  int _idx = 0;
  bool _isAdmin = false;

  @override
  void initState() {
    super.initState();
    _restoreAdmin();
  }

  Future<void> _restoreAdmin() async {
    final prefs = await SharedPreferences.getInstance();
    _isAdmin = prefs.getBool('is_admin') ?? false;
    if (mounted) setState(() {});
  }

  void _setAdmin(bool v) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('is_admin', v);
    setState(() => _isAdmin = v);
  }

  @override
  Widget build(BuildContext context) {
    final pages = [
      CalendarPage(onOpenSettings: _openSettings),
      const HeadlineNewsPage(),
      BoardPage(isAdmin: _isAdmin),
      const PlaceholderPage(title: 'ì§€ë„(ì˜µì…˜)'),
    ];

    return Scaffold(
      body: pages[_idx],
      bottomNavigationBar: NavigationBar(
        selectedIndex: _idx,
        onDestinationSelected: (i) => setState(() => _idx = i),
        destinations: const [
          NavigationDestination(icon: Icon(Icons.calendar_month), label: 'ìº˜ë¦°ë”'),
          NavigationDestination(icon: Icon(Icons.article), label: 'ë‰´ìŠ¤'),
          NavigationDestination(icon: Icon(Icons.forum), label: 'ê²Œì‹œíŒ'),
          NavigationDestination(icon: Icon(Icons.map), label: 'ì§€ë„'),
        ],
      ),
    );
  }

  // âš™ï¸ ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸
  Future<void> _openSettings() async {
    final prefs = await SharedPreferences.getInstance();
    final TextEditingController pw = TextEditingController();
    bool tempAdmin = _isAdmin;
    ThemeMode tempMode = appTheme.value;

    await showDialog(
      context: context,
      builder: (ctx) {
        return StatefulBuilder(builder: (ctx, setState) {
          return AlertDialog(
            title: const Text('ì„¤ì •'),
            content: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('í…Œë§ˆ ì„ íƒ'),
                  const SizedBox(height: 8),
                  SegmentedButton<ThemeMode>(
                    segments: const [
                      ButtonSegment(value: ThemeMode.light, label: Text('ë¼ì´íŠ¸')),
                      ButtonSegment(value: ThemeMode.dark, label: Text('ë‹¤í¬')),
                      ButtonSegment(value: ThemeMode.system, label: Text('ì‹œìŠ¤í…œ')),
                    ],
                    selected: {tempMode},
                    onSelectionChanged: (s) => setState(() => tempMode = s.first),
                  ),
                  const SizedBox(height: 20),
                  TextField(
                    controller: pw,
                    obscureText: true,
                    decoration: const InputDecoration(
                      labelText: 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸',
                      border: OutlineInputBorder(),
                    ),
                  ),
                  const SizedBox(height: 8),
                  ElevatedButton(
                    onPressed: () {
                      if (pw.text == kAdminPassword) {
                        tempAdmin = true;
                        ScaffoldMessenger.of(ctx).showSnackBar(
                          const SnackBar(content: Text('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ')),
                        );
                        setState(() {});
                      } else {
                        ScaffoldMessenger.of(ctx).showSnackBar(
                          const SnackBar(content: Text('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.')),
                        );
                      }
                    },
                    child: const Text('ë¡œê·¸ì¸'),
                  ),
                  if (tempAdmin)
                    Row(
                      children: [
                        const Icon(Icons.verified, color: Colors.green),
                        const SizedBox(width: 6),
                        const Text('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”'),
                        const Spacer(),
                        TextButton(
                          onPressed: () {
                            tempAdmin = false;
                            ScaffoldMessenger.of(ctx).showSnackBar(
                              const SnackBar(content: Text('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤')),
                            );
                            setState(() {});
                          },
                          child: const Text('ë¡œê·¸ì•„ì›ƒ'),
                        ),
                      ],
                    ),
                ],
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(ctx),
                child: const Text('ë‹«ê¸°'),
              ),
              ElevatedButton(
                onPressed: () async {
                  appTheme.value = tempMode;
                  await prefs.setString('theme_mode', switch (tempMode) {
                    ThemeMode.light => 'light',
                    ThemeMode.dark => 'dark',
                    _ => 'system',
                  });
                  _setAdmin(tempAdmin);
                  if (ctx.mounted) Navigator.pop(ctx);
                },
                child: const Text('ì €ì¥'),
              ),
            ],
          );
        });
      },
    );
  }
}
// ================== ìº˜ë¦°ë”: ìë™ í¬ë¡¤ë§ + ë‰´ìŠ¤ íŒŒì‹± ==================
class CalendarPage extends StatefulWidget {
  final Future<void> Function()? onOpenSettings;
  const CalendarPage({super.key, this.onOpenSettings});
  @override
  State<CalendarPage> createState() => _CalendarPageState();
}

class _CalendarPageState extends State<CalendarPage> {
  DateTime _focused = DateTime.now();
  DateTime? _selected;

  // ë‚ ì§œí‚¤ -> ì´ë²¤íŠ¸
  final Map<String, List<EventItem>> _events = {};
  bool _syncing = false;

  // ì¹´í…Œê³ ë¦¬ íƒ­
  EventCategory _selectedCat = EventCategory.festival;
  List<NewsHeadline> _headlines = [];

  @override
  void initState() {
    super.initState();
    _restoreEvents().then((_) async {
      _seedSportsFromScreenshot();
      await _persistEvents();
      await _syncAll(); // ì „ì‹œ í¬ë¡¤ë§ + ë‰´ìŠ¤ ë™ê¸°í™”
    });
  }

  // ---------- ì €ì¥/ë³µêµ¬ ----------
  Future<void> _restoreEvents() async {
    final prefs = await SharedPreferences.getInstance();
    final s = prefs.getString('ulsan_events');
    if (s == null) return;
    final map = json.decode(s) as Map<String, dynamic>;
    _events.clear();
    map.forEach((k, v) {
      _events[k] =
          (v as List).map((e) => EventItem.fromJson(e as Map<String, dynamic>)).toList();
    });
    if (mounted) setState(() {});
  }

  Future<void> _persistEvents() async {
    final prefs = await SharedPreferences.getInstance();
    final save =
    _events.map((k, v) => MapEntry(k, v.map((e) => e.toJson()).toList()));
    await prefs.setString('ulsan_events', json.encode(save));
  }

  // ---------- ìœ í‹¸ ----------
  DateTime _dateOnly(DateTime d) => DateTime(d.year, d.month, d.day);
  String _keyOf(DateTime d) {
    final x = _dateOnly(d);
    return '${x.year}-${x.month}-${x.day}';
  }

  List<EventItem> _getEvents(DateTime d) => _events[_keyOf(d)] ?? [];

  void _addEventRange(EventItem e) {
    final start = _dateOnly(e.start);
    final end = _dateOnly(e.end);
    for (DateTime d = start; !d.isAfter(end); d = d.add(const Duration(days: 1))) {
      final k = _keyOf(d);
      _events.putIfAbsent(k, () => []);
      // ì¤‘ë³µ ë°©ì§€(ì œëª©/ì¹´í…Œê³ ë¦¬/ë§í¬ ë™ì¼ì‹œ ìŠ¤í‚µ)
      if (!_events[k]!
          .any((x) => x.title == e.title && x.category == e.category && x.url == e.url)) {
        _events[k]!.add(e);
      }
    }
  }

  String _shortTitle(String t) {
    final s = t.replaceAll(RegExp(r'\s+'), ' ').trim();
    return s.length > 18 ? '${s.substring(0, 18)}â€¦' : s;
  }

  // ---------- ì‹œë“œ ìŠ¤í¬ì¸  ----------
  void _seedSportsFromScreenshot() {
    final y = DateTime.now().year;
    final seeds = <EventItem>[
      EventItem(
        title: _shortTitle('ë¡¯ë° vs NC (ë¬¸ìˆ˜ì•¼êµ¬ê²½ê¸°ì¥, 18:30)'),
        start: DateTime(y, 9, 23),
        end: DateTime(y, 9, 23),
        category: EventCategory.sport,
        url: null,
      ),
      EventItem(
        title: _shortTitle('ë¡¯ë° vs LG (ë¬¸ìˆ˜ì•¼êµ¬ê²½ê¸°ì¥, 18:30)'),
        start: DateTime(y, 9, 25),
        end: DateTime(y, 9, 25),
        category: EventCategory.sport,
        url: null,
      ),
    ];
    for (final e in seeds) {
      _addEventRange(e);
    }
    setState(() {}); // ì¦‰ì‹œ ë°˜ì˜
  }

  // ---------- ë™ê¸°í™”(ì „ì‹œ í¬ë¡¤ë§ + ë‰´ìŠ¤ íŒŒì‹±) ----------
  Future<void> _syncAll() async {
    setState(() => _syncing = true);
    try {
      // (1) ìš¸ì‚°ì‹œ ì „ì‹œ/ê³µì—° í¬ë¡¤ë§
      final exhibitions = await _crawlUlsanCulture();
      for (final e in exhibitions) {
        _addEventRange(e);
      }

      // (2) ë‰´ìŠ¤ í—¤ë“œë¼ì¸ ìˆ˜ì§‘(ì¹´í…Œê³ ë¦¬ë³„) + ë‚ ì§œ íŒŒì‹± â†’ ì´ë²¤íŠ¸í™”
      final festHeads = await _fetchNewsHeads(
        'ìš¸ì‚° ì¶•ì œ OR êµ­ê°€ì •ì› ì¶•ì œ OR ìš¸ì‚° í˜ìŠ¤í‹°ë²Œ OR ìš¸ì‚° í–‰ì‚¬',
        EventCategory.festival,
      );
      final exHeads = await _fetchNewsHeads(
        'ìš¸ì‚° ê³µì—° OR ìš¸ì‚° ì „ì‹œ OR ìš¸ì‚° ë¬¸í™”ì˜ˆìˆ ',
        EventCategory.exhibition,
      );
      final sportHeads = await _fetchNewsHeads(
        'ë¬¸ìˆ˜ê²½ê¸°ì¥ OR ë¬¸ìˆ˜ì¶•êµ¬ê²½ê¸°ì¥ OR ìš¸ì‚° í˜„ëŒ€ í™ˆê²½ê¸° OR ìš¸ì‚°HD ê²½ê¸° ì¼ì •',
        EventCategory.sport,
      );

      // í˜„ì¬ ì„ íƒ ì¹´í…Œê³ ë¦¬ì˜ í—¤ë“œë¼ì¸ë§Œ í‘œì‹œ
      _headlines = switch (_selectedCat) {
        EventCategory.festival => festHeads,
        EventCategory.exhibition => exHeads,
        EventCategory.sport => sportHeads,
      };

      // ë‰´ìŠ¤ â†’ ì¼ì • ë°˜ì˜
      _eventsFromNews(festHeads);
      _eventsFromNews(exHeads);
      _eventsFromNews(sportHeads);

      await _persistEvents();
    } catch (_) {
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜/êµ¬ì¡° ë³€ê²½ ë“±ì€ ì¡°ìš©íˆ ë¬´ì‹œ
    } finally {
      if (mounted) setState(() => _syncing = false);
    }
  }

  // ìš¸ì‚°ì‹œ ë¬¸í™”(ì „ì‹œ/ê³µì—°) í˜ì´ì§€ í¬ë¡¤ë§(ê²¬ê³ í•œ íŒ¨í„´)
  Future<List<EventItem>> _crawlUlsanCulture() async {
    final url = Uri.parse('https://www.ulsan.go.kr/s/uam/main.ulsan');
    final res = await http.get(url, headers: {
      'User-Agent':
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0 Safari/537.36'
    });
    if (res.statusCode != 200) return [];

    final doc = html_parser.parse(utf8.decode(res.bodyBytes));

    // ë‹¤ì–‘í•œ ìš”ì†Œë¥¼ ëª¨ì•„ì„œ í…ìŠ¤íŠ¸ ë‚´ "ì „ì‹œ/ê³µì—°/ë¬¸í™”/í–‰ì‚¬"ê°€ í¬í•¨ëœ ë¸”ë¡ë§Œ í•„í„°
    final cands = <dom.Element>[];
    cands.addAll(doc.querySelectorAll('a'));
    cands.addAll(doc.querySelectorAll('li'));
    cands.addAll(doc.querySelectorAll('div'));

    final resList = <EventItem>[];

    // ë‚ ì§œ/ê¸°ê°„ íŒ¨í„´
    final regRange = RegExp(
        r'(\d{4})?\s*\.?\s*(\d{1,2})\s*\.\s*(\d{1,2})\s*(?:\([ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼]\))?\s*[~\-]\s*(?:(\d{4})?\s*\.?\s*)?(\d{1,2})\s*\.\s*(\d{1,2})');
    final regSingle = RegExp(
        r'(?:(\d{4})\s*\.?)?\s*(\d{1,2})\s*\.\s*(\d{1,2})\s*(?:\([ì›”í™”ìˆ˜ëª©ê¸ˆí† ì¼]\))?');

    for (final el in cands) {
      final text = el.text.replaceAll('\n', ' ').replaceAll(RegExp(r'\s+'), ' ').trim();
      if (!(text.contains('ì „ì‹œ') ||
          text.contains('ê³µì—°') ||
          text.contains('ë¬¸í™”') ||
          text.contains('í–‰ì‚¬'))) continue;

      DateTime? s, e;

      final mR = regRange.firstMatch(text);
      if (mR != null) {
        final y1 = (mR.group(1)?.isNotEmpty ?? false)
            ? int.parse(mR.group(1)!)
            : DateTime.now().year;
        final m1 = int.parse(mR.group(2)!);
        final d1 = int.parse(mR.group(3)!);
        final y2 = (mR.group(4)?.isNotEmpty ?? false) ? int.parse(mR.group(4)!) : y1;
        final m2 = int.parse(mR.group(5)!);
        final d2 = int.parse(mR.group(6)!);
        s = DateTime(y1, m1, d1);
        e = DateTime(y2, m2, d2);
      } else {
        final mS = regSingle.firstMatch(text);
        if (mS != null) {
          final y =
          (mS.group(1)?.isNotEmpty ?? false) ? int.parse(mS.group(1)!) : DateTime.now().year;
          final mm = int.parse(mS.group(2)!);
          final dd = int.parse(mS.group(3)!);
          s = DateTime(y, mm, dd);
          e = s;
        }
      }

      if (s == null || e == null) continue;

      // ì œëª© í›„ë³´ ì¶”ì¶œ
      String title = _titlePref(text);
      if (title.isEmpty) title = text;

      // ë§í¬ ì¶”ì¶œ
      String? link;
      final linkTag = el.querySelector('a');
      if (linkTag != null) {
        final href = linkTag.attributes['href'];
        if (href != null && href.isNotEmpty) {
          link = href.startsWith('http') ? href : 'https://www.ulsan.go.kr$href';
        }
      }

      resList.add(EventItem(
        title: _shortTitle(title),
        start: s,
        end: e,
        category: EventCategory.exhibition,
        url: link,
      ));
    }
    return resList;
  }

  String _titlePref(String raw) {
    final r = RegExp(r'ã€Œ([^ã€]+)ã€|ã€([^ã€]+)ã€|â€œ([^â€]+)â€|\"([^\"]+)\"|\[([^\]]+)\]');
    final m = r.firstMatch(raw);
    if (m != null) {
      for (int i = 1; i <= 5; i++) {
        final g = m.group(i);
        if (g != null && g.trim().isNotEmpty) return g.trim();
      }
    }
    if (raw.contains(':')) return raw.split(':').first.trim();
    return raw.trim();
  }

  Future<List<NewsHeadline>> _fetchNewsHeads(
      String query, EventCategory cat) async {
    if (NEWS_API_KEY.isEmpty || NEWS_API_KEY == 'YOUR_NEWSAPI_KEY') return [];
    final url = Uri.parse(
        'https://newsapi.org/v2/everything?q=$query&language=ko&sortBy=publishedAt&pageSize=40&apiKey=$NEWS_API_KEY');
    final res = await http.get(url);
    if (res.statusCode != 200) return [];
    final data = json.decode(res.body);
    final List arr = data['articles'] ?? [];
    return arr
        .map((a) => NewsHeadline(
      title: (a['title'] ?? '').toString(),
      url: ((a['url'] ?? '') as String).isEmpty ? null : a['url'],
      category: cat,
    ))
        .where((h) => h.title.isNotEmpty)
        .toList();
  }

  // í—¤ë“œë¼ì¸ì—ì„œ ë‚ ì§œ/ê¸°ê°„ íŒŒì‹± â†’ ì´ë²¤íŠ¸ë¡œ ë³€í™˜
  void _eventsFromNews(List<NewsHeadline> list) {
    final year = DateTime.now().year;

    final patRangeSameMonth =
    RegExp(r'(\d{1,2})\s*ì›”\s*(\d{1,2})\s*~\s*(\d{1,2})\s*ì¼'); // 9ì›” 24~26ì¼
    final patRangeCross = RegExp(
        r'(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼\s*[~\-]\s*(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼');
    final patSingle = RegExp(r'(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼');

    for (final h in list) {
      final t = h.title;
      DateTime? s, e;

      final mCross = patRangeCross.firstMatch(t);
      if (mCross != null) {
        final m1 = int.parse(mCross.group(1)!);
        final d1 = int.parse(mCross.group(2)!);
        final m2 = int.parse(mCross.group(3)!);
        final d2 = int.parse(mCross.group(4)!);
        s = DateTime(year, m1, d1);
        e = DateTime(year, m2, d2);
      } else {
        final mSame = patRangeSameMonth.firstMatch(t);
        if (mSame != null) {
          final m = int.parse(mSame.group(1)!);
          final d1 = int.parse(mSame.group(2)!);
          final d2 = int.parse(mSame.group(3)!);
          s = DateTime(year, m, d1);
          e = DateTime(year, m, d2);
        } else {
          final mOne = patSingle.firstMatch(t);
          if (mOne != null) {
            final m = int.parse(mOne.group(1)!);
            final d = int.parse(mOne.group(2)!);
            s = DateTime(year, m, d);
            e = s;
          }
        }
      }

      if (s != null && e != null) {
        _addEventRange(EventItem(
          title: _shortTitle(_titlePref(t)),
          start: s,
          end: e,
          category: h.category,
          url: h.url,
        ));
      }
    }
  }

  // ---------- UI ----------
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ìš¸ì‚°ìº˜ë¦°ë”'),
        actions: [
          IconButton(
            tooltip: 'ë™ê¸°í™”(ì „ì‹œ/ë‰´ìŠ¤)',
            onPressed: _syncing ? null : _syncAll,
            icon: _syncing
                ? const SizedBox(
                width: 20, height: 20, child: CircularProgressIndicator())
                : const Icon(Icons.sync),
          ),
          IconButton(
            tooltip: 'ì„¤ì •',
            onPressed: widget.onOpenSettings,
            icon: const Icon(Icons.settings),
          ),
        ],
      ),
      body: Column(
        children: [
          TableCalendar<EventItem>(
            locale: 'ko_KR',
            firstDay: DateTime.utc(2020, 1, 1),
            lastDay: DateTime.utc(2032, 12, 31),
            focusedDay: _focused,
            selectedDayPredicate: (d) => isSameDay(_selected, d),
            onDaySelected: (sel, foc) {
              setState(() {
                _selected = sel;
                _focused = foc;
              });
              showModalBottomSheet(
                context: context,
                builder: (_) => _eventSheet(sel),
              );
            },
            eventLoader: _getEvents,
            calendarBuilders: CalendarBuilders<EventItem>(
              markerBuilder: (context, date, events) {
                if (events.isEmpty) return const SizedBox();
                final dots = events.take(3).map((e) {
                  return Container(
                    margin: const EdgeInsets.symmetric(horizontal: 1.5),
                    width: 6,
                    height: 6,
                    decoration: BoxDecoration(
                      color: e.category.dot,
                      shape: BoxShape.circle,
                    ),
                  );
                }).toList();
                return Positioned(bottom: 2, child: Row(children: dots));
              },
            ),
            calendarStyle: const CalendarStyle(
              todayDecoration: BoxDecoration(color: Colors.blue, shape: BoxShape.circle),
              selectedDecoration: BoxDecoration(color: Colors.orange, shape: BoxShape.circle),
            ),
          ),
          const SizedBox(height: 10),
          // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 12),
            child: Row(
              children: [
                _catButton(EventCategory.festival),
                _catButton(EventCategory.exhibition),
                _catButton(EventCategory.sport),
              ],
            ),
          ),
          const SizedBox(height: 8),
          // í—¤ë“œë¼ì¸(í´ë¦­ â†’ ë§í¬)
          Expanded(
            child: _headlines.isEmpty
                ? const Center(child: Text('í—¤ë“œë¼ì¸ì´ ì•„ì§ ì—†ì–´ìš”. ìƒë‹¨ â†» ë™ê¸°í™” ëˆŒëŸ¬ë´!'))
                : ListView.builder(
              itemCount: _headlines.length,
              itemBuilder: (c, i) {
                final h = _headlines[i];
                return ListTile(
                  dense: true,
                  title: Text(h.title),
                  trailing: const Icon(Icons.open_in_new),
                  onTap: () async {
                    if (h.url == null) return;
                    final uri = Uri.parse(h.url!);
                    if (await canLaunchUrl(uri)) {
                      await launchUrl(uri, mode: LaunchMode.externalApplication);
                    }
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _catButton(EventCategory cat) {
    final sel = _selectedCat == cat;
    return Expanded(
      child: GestureDetector(
        onTap: () async {
          setState(() {
            _selectedCat = cat;
            _headlines = [];
          });
          List<NewsHeadline> heads = [];
          if (cat == EventCategory.festival) {
            heads = await _fetchNewsHeads(
                'ìš¸ì‚° ì¶•ì œ OR êµ­ê°€ì •ì› ì¶•ì œ OR ìš¸ì‚° í˜ìŠ¤í‹°ë²Œ OR ìš¸ì‚° í–‰ì‚¬', cat);
          } else if (cat == EventCategory.exhibition) {
            heads = await _fetchNewsHeads('ìš¸ì‚° ê³µì—° OR ìš¸ì‚° ì „ì‹œ OR ìš¸ì‚° ë¬¸í™”ì˜ˆìˆ ', cat);
          } else {
            heads = await _fetchNewsHeads(
                'ë¬¸ìˆ˜ê²½ê¸°ì¥ OR ë¬¸ìˆ˜ì¶•êµ¬ê²½ê¸°ì¥ OR ìš¸ì‚° í˜„ëŒ€ í™ˆê²½ê¸° OR ìš¸ì‚°HD ê²½ê¸° ì¼ì •', cat);
          }
          if (mounted) setState(() => _headlines = heads);
        },
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 180),
          margin: const EdgeInsets.symmetric(horizontal: 4),
          padding: const EdgeInsets.symmetric(vertical: 10),
          decoration: BoxDecoration(
            color: sel ? cat.pastel : cat.pastel.withOpacity(0.4),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: sel ? Colors.black45 : Colors.transparent),
          ),
          child: Center(
            child: Text(cat.label, style: const TextStyle(fontWeight: FontWeight.bold)),
          ),
        ),
      ),
    );
  }

  Widget _eventSheet(DateTime day) {
    final list = _getEvents(day);
    return SizedBox(
      height: 360,
      child: Column(
        children: [
          ListTile(
            title: Text("${day.year}.${day.month}.${day.day} ì¼ì • (${list.length}ê°œ)"),
          ),
          const Divider(height: 1),
          Expanded(
            child: list.isEmpty
                ? const Center(child: Text('ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.'))
                : ListView.separated(
              itemCount: list.length,
              separatorBuilder: (_, __) => const Divider(height: 1),
              itemBuilder: (c, i) {
                final e = list[i];
                final range = e.start.isAtSameMomentAs(e.end)
                    ? "${e.start.month}/${e.start.day}"
                    : "${e.start.month}/${e.start.day}~${e.end.month}/${e.end.day}";
                return ListTile(
                  leading: Icon(Icons.event, color: e.category.dot),
                  title: Text(e.title),
                  subtitle: Text('${e.category.label} Â· $range'),
                  trailing: e.url != null ? const Icon(Icons.open_in_new) : null,
                  onTap: () async {
                    if (e.url == null) return;
                    final uri = Uri.parse(e.url!);
                    if (await canLaunchUrl(uri)) {
                      await launchUrl(uri, mode: LaunchMode.externalApplication);
                    }
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

// ================== ë‰´ìŠ¤ íƒ­ ==================
class HeadlineNewsPage extends StatefulWidget {
  const HeadlineNewsPage({super.key});
  @override
  State<HeadlineNewsPage> createState() => _HeadlineNewsPageState();
}

class _HeadlineNewsPageState extends State<HeadlineNewsPage> {
  List<NewsHeadline> _items = [];
  bool _loading = true;

  @override
  void initState() {
    super.initState();
    _load();
  }

  Future<void> _load() async {
    if (NEWS_API_KEY.isEmpty || NEWS_API_KEY == 'YOUR_NEWSAPI_KEY') {
      setState(() {
        _items = [];
        _loading = false;
      });
      return;
    }
    final url = Uri.parse(
        'https://newsapi.org/v2/everything?q=ìš¸ì‚°&language=ko&sortBy=publishedAt&pageSize=40&apiKey=$NEWS_API_KEY');
    final res = await http.get(url);
    if (!mounted) return;
    if (res.statusCode == 200) {
      final data = json.decode(res.body);
      final List arr = data['articles'] ?? [];
      setState(() {
        _items = arr
            .map((a) => NewsHeadline(
          title: (a['title'] ?? '').toString(),
          url: ((a['url'] ?? '') as String).isEmpty ? null : a['url'],
          category: EventCategory.festival, // ì˜ë¯¸ ì—†ìŒ(íƒ­ìš©)
        ))
            .where((h) => h.title.isNotEmpty)
            .toList();
        _loading = false;
      });
    } else {
      setState(() => _loading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('ğŸ“° ìš¸ì‚° ë‰´ìŠ¤(í—¤ë“œë¼ì¸)')),
      body: _loading
          ? const Center(child: CircularProgressIndicator())
          : _items.isEmpty
          ? const Center(child: Text('API í‚¤ê°€ ì—†ê±°ë‚˜ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.'))
          : ListView.separated(
        itemCount: _items.length,
        separatorBuilder: (_, __) => const Divider(height: 1),
        itemBuilder: (c, i) {
          final h = _items[i];
          return ListTile(
            title: Text(h.title),
            trailing: const Icon(Icons.open_in_new),
            onTap: () async {
              if (h.url == null) return;
              final uri = Uri.parse(h.url!);
              if (await canLaunchUrl(uri)) {
                await launchUrl(uri, mode: LaunchMode.externalApplication);
              }
            },
          );
        },
      ),
    );
  }
}

// ================== ììœ ê²Œì‹œíŒ (â¤ï¸ + ë‚ ì§œ + ê´€ë¦¬ì ì‚­ì œ) ==================
class BoardPage extends StatefulWidget {
  final bool isAdmin;
  const BoardPage({super.key, required this.isAdmin});
  @override
  State<BoardPage> createState() => _BoardPageState();
}

class _BoardPageState extends State<BoardPage> {
  final controller = TextEditingController();
  List<PostItem> posts = [];
  Set<String> likedIds = {}; // ë‚´ ê¸°ê¸°ì—ì„œ ê³µê° ëˆ„ë¥¸ ê¸€ id ëª¨ìŒ

  @override
  void initState() {
    super.initState();
    _load();
  }

  Future<void> _load() async {
    final prefs = await SharedPreferences.getInstance();
    final raw = prefs.getString('posts_json');
    final liked = prefs.getStringList('liked_ids') ?? [];
    if (raw != null) {
      final List arr = json.decode(raw);
      posts = arr.map((e) => PostItem.fromJson(e)).toList();
    }
    likedIds = liked.toSet();
    if (mounted) setState(() {});
  }

  Future<void> _save() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('posts_json', json.encode(posts.map((e) => e.toJson()).toList()));
    await prefs.setStringList('liked_ids', likedIds.toList());
  }

  void _add() async {
    final t = controller.text.trim();
    if (t.isEmpty) return;
    final item = PostItem(
      id: DateTime.now().microsecondsSinceEpoch.toString(),
      content: t,
      createdAt: DateTime.now(),
      likes: 0,
    );
    setState(() => posts.insert(0, item));
    controller.clear();
    await _save();
  }

  void _toggleLike(PostItem p) async {
    final idx = posts.indexWhere((e) => e.id == p.id);
    if (idx < 0) return;
    final isLiked = likedIds.contains(p.id);
    final newLikes = (p.likes) + (isLiked ? -1 : 1);
    setState(() {
      posts[idx] = p.copyWith(likes: newLikes.clamp(0, 1 << 31));
      if (isLiked) {
        likedIds.remove(p.id);
      } else {
        likedIds.add(p.id);
      }
    });
    await _save();
  }

  void _delete(PostItem p) async {
    setState(() => posts.removeWhere((e) => e.id == p.id));
    likedIds.remove(p.id);
    await _save();
  }

  String _fmtDate(DateTime d) => DateFormat('yyyy.MM.dd HH:mm', 'ko_KR').format(d);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('ğŸ’¬ ììœ ê²Œì‹œíŒ')),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(8),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: controller,
                    decoration: const InputDecoration(
                      hintText: 'ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”',
                      border: OutlineInputBorder(),
                    ),
                    minLines: 1,
                    maxLines: 4,
                  ),
                ),
                const SizedBox(width: 8),
                ElevatedButton(onPressed: _add, child: const Text('ë“±ë¡')),
              ],
            ),
          ),
          Expanded(
            child: posts.isEmpty
                ? const Center(child: Text('ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!'))
                : ListView.separated(
              itemCount: posts.length,
              separatorBuilder: (_, __) => const Divider(height: 1),
              itemBuilder: (c, i) {
                final p = posts[i];
                final isLiked = likedIds.contains(p.id);
                return ListTile(
                  title: Text(p.content),
                  subtitle: Text(_fmtDate(p.createdAt)),
                  trailing: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // â¤ï¸ ê³µê°
                      InkWell(
                        onTap: () => _toggleLike(p),
                        child: Row(
                          children: [
                            Icon(
                              isLiked ? Icons.favorite : Icons.favorite_border,
                              color: Colors.redAccent,
                            ),
                            const SizedBox(width: 4),
                            Text('${p.likes}'),
                          ],
                        ),
                      ),
                      const SizedBox(width: 12),
                      // ì‚­ì œ(ê´€ë¦¬ìë§Œ)
                      if (widget.isAdmin)
                        IconButton(
                          tooltip: 'ì‚­ì œ(ê´€ë¦¬ì)',
                          icon: const Icon(Icons.delete_forever),
                          onPressed: () => _delete(p),
                        ),
                    ],
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

// ================== ì§€ë„ ìë¦¬(ì˜µì…˜) ==================
class PlaceholderPage extends StatelessWidget {
  final String title;
  const PlaceholderPage({super.key, required this.title});
  @override
  Widget build(BuildContext context) {
    return Scaffold(appBar: AppBar(title: Text(title)), body: const SizedBox());
  }
}
